# 會員中心架構演進計劃

## 現況分析

### 當前架構
- **主系統**: eccal.thinkwithblack.com (廣告分析平台)
- **子服務**: audai.thinkwithblack.com (AI 音頻分析)
- **認證**: JWT 基於 eccal 系統
- **資料庫**: 統一存儲在 eccal 系統

## 演進方案

### Phase 1: 整併階段 (現在 - 3個月)

#### 目標
- 快速上線 AudAI 服務
- 最小化開發成本
- 驗證多服務架構

#### 實施
1. **用戶資料整併**
   - 在現有 users 表中新增 `service_permissions` 欄位
   - 記錄用戶對不同服務的授權狀態

2. **服務標識系統**
   ```sql
   -- 新增服務權限表
   CREATE TABLE user_service_permissions (
     id SERIAL PRIMARY KEY,
     user_id VARCHAR(255) REFERENCES users(id),
     service_name VARCHAR(50) NOT NULL,
     permission_level VARCHAR(20) DEFAULT 'basic',
     granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
     expires_at TIMESTAMP,
     is_active BOOLEAN DEFAULT true
   );
   ```

3. **擴展 API 端點**
   ```javascript
   // 新增服務專用端點
   app.get('/api/account-center/services/:userId', async (req, res) => {
     // 獲取用戶所有服務權限
   });
   
   app.post('/api/account-center/services/:userId/grant', async (req, res) => {
     // 授予服務權限
   });
   ```

#### 優勢
- 立即可用
- 統一用戶體驗
- 簡化管理

#### 限制
- 服務間耦合
- 單點故障風險
- 未來擴展限制

### Phase 2: 分離階段 (3-6個月後)

#### 目標
- 建立專用會員中心
- 實現服務解耦
- 提升系統可擴展性

#### 新架構設計

```
┌─────────────────────────────────────────────────────────────┐
│                    member.thinkwithblack.com                │
│                      (會員中心)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   用戶管理      │  │   認證服務      │  │   會員系統      ││
│  │   User Mgmt     │  │   Auth Service  │  │   Membership    ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐│
│  │   點數系統      │  │   服務權限      │  │   推薦系統      ││
│  │   Credits       │  │   Permissions   │  │   Referrals     ││
│  └─────────────────┘  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
                                │
                                │ API Calls
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼────────┐    ┌────────▼────────┐    ┌────────▼────────┐
│     eccal      │    │     audai       │    │   future-app    │
│  .thinkwith    │    │  .thinkwith     │    │  .thinkwith     │
│   black.com    │    │   black.com     │    │   black.com     │
└────────────────┘    └─────────────────┘    └─────────────────┘
```

#### 實施步驟

1. **建立會員中心服務**
   - 部署 member.thinkwithblack.com
   - 複製現有認證系統
   - 建立用戶資料 API

2. **資料遷移**
   - 將用戶資料遷移到會員中心
   - 建立資料同步機制
   - 測試資料一致性

3. **服務改寫**
   - 更新 eccal 系統使用新的會員 API
   - 更新 audai 系統使用新的會員 API
   - 逐步移除舊的認證代碼

4. **上線切換**
   - 灰度發布新架構
   - 監控系統穩定性
   - 完全切換到新架構

#### 新架構優勢
- **職責分離**: 每個服務專注自己的業務邏輯
- **獨立擴展**: 會員中心可以獨立優化和擴展
- **容錯性**: 單個服務故障不影響其他服務
- **團隊協作**: 不同團隊可以獨立開發維護

### Phase 3: 優化階段 (6個月後)

#### 高級功能
1. **微服務架構**
   - 服務發現
   - 負載均衡
   - 健康檢查

2. **資料一致性**
   - 分散式事務
   - 事件驅動架構
   - CQRS 模式

3. **監控和日誌**
   - 統一日誌收集
   - 效能監控
   - 錯誤追蹤

## 決策建議

### 如果你有 2-3 個子服務
**建議**: 先使用 Phase 1 整併方案

### 如果你規劃 5+ 個子服務
**建議**: 直接實施 Phase 2 分離方案

### 如果你是技術團隊
**建議**: 可以考慮直接建立 member.thinkwithblack.com

### 如果你是個人開發
**建議**: 先整併到現有系統，降低複雜度

## 成本分析

### Phase 1 (整併)
- **開發時間**: 1-2 周
- **基礎設施**: 無額外成本
- **維護成本**: 低

### Phase 2 (分離)
- **開發時間**: 4-6 周
- **基礎設施**: 額外一個服務器
- **維護成本**: 中等

## 技術債務考量

### 短期整併的技術債務
- 服務間耦合
- 資料庫混合使用
- 單點故障風險

### 長期分離的技術投資
- 分散式系統複雜度
- 資料一致性挑戰
- 運維成本增加

## 我的推薦

考慮到你的當前需求和發展階段，我推薦：

1. **現在**: 使用 Phase 1 整併方案，快速上線 AudAI
2. **3個月後**: 評估服務數量和複雜度
3. **6個月後**: 如果有更多服務，考慮 Phase 2 分離方案

這樣可以平衡快速上線和未來擴展的需求。

你覺得這個演進計劃怎麼樣？還是你想要直接實施某個特定階段？